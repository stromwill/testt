name: RDP_TIPSUNIX_PRO_EDITION

on:
  workflow_dispatch:

jobs:
  rdp-admin-pro:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
        - name: ğŸš€ System Profiling & Optimization
        id: profile
        run: |
          echo "::group::Optimizing Windows"
          # RDP & Admin Config
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1 -Force
          Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name "Wallpaper" -Value ""
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          
          # FIX RAM: Menjumlahkan semua keping RAM sebelum dibagi
          $cpu = (Get-CimInstance Win32_Processor).Name
          $rawRam = (Get-CimInstance Win32_PhysicalMemory | Measure-Object -Property Capacity -Sum).Sum
          $ramGB = [Math]::Round($rawRam / 1GB)
          $ram = "[$ramGB GB]"
          
          echo "CPU=$cpu" >> $env:GITHUB_OUTPUT
          echo "RAM=$ram" >> $env:GITHUB_OUTPUT
          echo "::endgroup::"

      - name: ğŸ”‘ Secure Credential Generation
        id: user_gen
        run: |
          $pass = -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 20 | ForEach-Object {[char]$_})
          echo "::add-mask::$pass"
          $secPass = ConvertTo-SecureString $pass -AsPlainText -Force
          New-LocalUser -Name "Pro_Admin" -Password $secPass -AccountNeverExpires -Description "RDP Admin"
          Add-LocalGroupMember -Group "Administrators" -Member "Pro_Admin"
          echo "PASS=$pass" >> $env:GITHUB_OUTPUT

      - name: ğŸŒ Tailscale Mesh Deployment
        id: ts
        run: |
          echo "::group::Installing Tailscale"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile "ts.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "ts.msi", "/quiet", "/norestart" -Wait
          
          # Up with AuthKey
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=PRO-$(Get-Random)
          
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          if (!$tsIP) { throw "Tailscale IP failed to assign!" }
          echo "IP=$tsIP" >> $env:GITHUB_OUTPUT
          echo "::endgroup::"

      - name: ğŸ“¤ Professional Telegram Notification
        run: |
          $msg = @"
          ğŸ’ *PRO RDP SESSION ACTIVE*
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸš€ *Host:* ``${{ steps.ts.outputs.IP }}``
          ğŸ‘¤ *User:* ``Pro_Admin``
          ğŸ”‘ *Pass:* ``${{ steps.user_gen.outputs.PASS }}``
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ’» *Specs:* ${{ steps.profile.outputs.CPU }}
          ğŸ§  *RAM:* ${{ steps.profile.outputs.RAM }}
          ğŸŒ *Region:* ${{ steps.profile.outputs.REGION }}
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          âš¡ @TipsUNIX - Status: *ADMIN*
          "@
          
          $body = @{ chat_id="${{ secrets.TELEGRAM_CHAT_ID }}"; text=$msg; parse_mode="MarkdownV2" } | ConvertTo-Json
          Invoke-RestMethod -Uri "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" -Method Post -Body $body -ContentType "application/json"

      - name: â³ Keep-Alive & Monitoring
        run: |
          $start = Get-Date
          Write-Host "Monitoring session... (Max 6 Hours)"
          while ($true) {
            $now = Get-Date
            $diff = $now - $start
            if ($diff.TotalMinutes -ge 350) { 
               Write-Host "Timeout approaching. Cleaning up..."
               break 
            }
            Write-Host "Session running: $($diff.ToString('hh\:mm\:ss')) | Status: OK"
            Start-Sleep -Seconds 60
          }

- name: ğŸ§¹ Auto-Cleanup (Always Run)
        if: always()
        run: |
          $tsPath = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (Test-Path $tsPath) {
              Write-Host "Disconnecting Tailscale..."
              & $tsPath logout
          } else {
              Write-Host "Tailscale not installed, skipping logout."
          }
